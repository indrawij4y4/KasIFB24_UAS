import{j as e,y as R,a as z}from"./ui-DDsedppd.js";import{c as E,r as t}from"./vendor-S3JaNCHW.js";import{u as w}from"./useQuery-HP5jMptj.js";import{b as K,g as X,I as A,B as T,p as H,d as Z,f as ee,a as F}from"./index-DrW2PX68.js";import{u as B}from"./useMutation-CqpEhxY5.js";import{S as q}from"./Select-C6k_z98u.js";import{M as b}from"./Modal-BH-nBQtg.js";import{R as ae}from"./config-4dfLyK49.js";const ne=()=>new Date().getMonth()+1,te=()=>new Date().getFullYear(),_=1e7,P="10.000.000",Q=s=>{const u=typeof s=="string"?s.replace(/\D/g,""):s.toString();return u?parseInt(u).toLocaleString("id-ID"):""},W=s=>s.replace(/\D/g,""),se=()=>{const s=new Date,u=new Date(s.getFullYear(),s.getMonth(),1),h=s.getDate(),d=u.getDay(),f=Math.ceil((h+d)/7);return f>5?5:f};function pe(){const s=E(),u=K(),[h,d]=t.useState(!1),[f,x]=t.useState(!1),[S,i]=t.useState({open:!1,message:""}),[r,I]=t.useState(""),[o,D]=t.useState(ne().toString()),[c]=t.useState(te().toString()),[l,y]=t.useState(se().toString()),[n,k]=t.useState(""),{data:v,isLoading:$}=w({queryKey:["users"],queryFn:ee.getAll}),{data:g}=w({queryKey:["settings",o,c],queryFn:()=>F.getSettings(parseInt(o),parseInt(c)),staleTime:300*1e3}),{data:j}=w({queryKey:["studentsData",o,c],queryFn:()=>F.getStudents(parseInt(o),parseInt(c)),enabled:!!r}),Y=a=>{if(!j||!r)return!1;const m=j.find(V=>V.id.toString()===r);if(!m)return!1;const C=`m${a}`,M=m[C]||0,N=g?.weeklyFee||0;return N>0&&M>=N},J=X(parseInt(c),parseInt(o)-1),p=Array.from({length:J},(a,m)=>m+1).map(a=>({label:`Minggu ${a}`,value:a.toString(),disabled:Y(a)})).filter(a=>!a.disabled);t.useEffect(()=>{v&&v.length>0&&!r&&I(v[0].id.toString())},[v,r]),t.useEffect(()=>{p.length>0?p.some(m=>m.value===l)||y(p[0].value):l!=="-"&&y("-")},[p,l]),t.useEffect(()=>{if(g?.weeklyFee!==void 0&&l!=="-"&&r){const a=g.weeklyFee;let m=a;if(j){const C=j.find(M=>M.id.toString()===r);if(C){const M=`m${l}`,N=C[M]||0;N>0&&(m=a-N,m<0&&(m=0))}}k(m.toString())}},[g,o,c,l,r,j]);const O=B({mutationFn:async()=>H.store({user_id:parseInt(r),bulan:parseInt(o),tahun:parseInt(c),minggu_ke:parseInt(l),nominal:parseInt(n)}),onSuccess:()=>{u.invalidateQueries({queryKey:["students"]}),u.invalidateQueries({queryKey:["dashboardStats"]}),u.invalidateQueries({queryKey:["arrears"]}),d(!1),x(!0)},onError:a=>{d(!1),i({open:!0,message:a.message||"Terjadi kesalahan saat menyimpan data. Silakan coba lagi."})}}),L=g?.is_configured!==!1,U=()=>{if(!r||!n){i({open:!0,message:"Lengkapi semua field!"});return}if(g?.is_configured===!1){i({open:!0,message:"Bulan ini belum dikonfigurasi oleh Admin. Silakan hubungi admin untuk melakukan konfigurasi keuangan di menu Pengaturan."});return}if((!l||l==="-")&&p.length===0){i({open:!0,message:"Mahasiswa ini sudah lunas untuk bulan ini."});return}const a=parseInt(n);if(a>_){i({open:!0,message:`Nominal melebihi batas maksimum. Maksimum input yang diizinkan adalah Rp ${P}. Silakan masukkan nominal yang lebih kecil.`});return}if(a<=0){i({open:!0,message:"Nominal harus lebih dari Rp 0. Silakan masukkan nominal yang valid."});return}d(!0)},G=[{label:"Januari",value:"1"},{label:"Februari",value:"2"},{label:"Maret",value:"3"},{label:"April",value:"4"},{label:"Mei",value:"5"},{label:"Juni",value:"6"},{label:"Juli",value:"7"},{label:"Agustus",value:"8"},{label:"September",value:"9"},{label:"Oktober",value:"10"},{label:"November",value:"11"},{label:"Desember",value:"12"}];return e.jsxs("div",{className:"p-4 md:p-6 bg-background min-h-screen animate-fadeIn",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:()=>s("/"),className:"w-10 h-10 bg-card rounded-xl shadow-sm border border-border flex items-center justify-center text-muted-foreground active:scale-95 transition-transform",children:e.jsx(R,{className:"w-6 h-6"})}),e.jsx("h2",{className:"text-xl font-bold text-foreground",children:"Input Iuran"})]}),$?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(z,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"bg-card p-6 rounded-3xl shadow-sm space-y-4 border border-border",children:[g?.is_configured===!1&&e.jsx("div",{className:"bg-amber-500/10 border border-amber-500/20 text-amber-600 p-4 rounded-xl text-sm font-medium flex items-center gap-2",children:e.jsx("span",{children:"⚠️ Bulan ini belum dikonfigurasi. Tidak dapat menginput data."})}),e.jsx(q,{label:"Nama Mahasiswa",value:r,onChange:a=>I(a.target.value),options:v?.map(a=>({label:a.nama,value:a.id.toString()}))||[]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsx(q,{label:"Bulan",value:o,onChange:a=>D(a.target.value),options:G}),e.jsx(q,{label:"Minggu Ke",value:l,onChange:a=>y(a.target.value),options:p.length>0?p:[{label:"Lunas Semua",value:"-"}],disabled:p.length===0||!L})]}),e.jsx(A,{label:"Nominal (Rp)",type:"text",inputMode:"numeric",value:Q(n),onChange:a=>k(W(a.target.value)),placeholder:"10.000",disabled:!L}),e.jsx(T,{onClick:U,variant:"success",className:"w-full",isLoading:O.isPending,disabled:!L,children:"Simpan Iuran"})]}),e.jsx(b,{isOpen:h,onClose:()=>d(!1),onConfirm:()=>O.mutate(),title:"Konfirmasi",description:"Simpan data iuran ke sistem?",type:"confirm",confirmLabel:O.isPending?"Menyimpan...":"Ya, Simpan"}),e.jsx(b,{isOpen:f,onClose:()=>{x(!1),s("/")},title:"Berhasil",description:"Data iuran berhasil disimpan!",type:"success"}),e.jsx(b,{isOpen:S.open,onClose:()=>i({open:!1,message:""}),title:"Gagal",description:S.message,type:"error"})]})}function ge(){const s=E(),u=K(),[h,d]=t.useState(!1),[f,x]=t.useState(!1),[S,i]=t.useState({open:!1,message:""}),[r,I]=t.useState(""),[o,D]=t.useState(""),{data:c}=w({queryKey:["dashboardStats"],queryFn:F.getStats,staleTime:60*1e3,refetchInterval:ae}),l=B({mutationFn:async()=>{const n=new FormData;return n.append("judul",r),n.append("nominal",o),n.append("tanggal",new Date().toISOString().split("T")[0]),Z.store(n)},onSuccess:()=>{u.invalidateQueries({queryKey:["transactions"]}),u.invalidateQueries({queryKey:["dashboardStats"]}),d(!1),x(!0)},onError:n=>{d(!1),i({open:!0,message:n.message||"Gagal menyimpan data belanja."})}}),y=()=>{if(!r||!o){i({open:!0,message:"Lengkapi judul dan nominal!"});return}const n=parseInt(o),k=c?.balance||0;if(n>_){i({open:!0,message:`Nominal melebihi batas maksimum. Maksimum input yang diizinkan adalah Rp ${P}. Silakan masukkan nominal yang lebih kecil.`});return}if(n<=0){i({open:!0,message:"Nominal harus lebih dari Rp 0. Silakan masukkan nominal yang valid."});return}if(n>k){i({open:!0,message:`Saldo tidak cukup! Saldo saat ini: Rp ${k.toLocaleString("id-ID")}, nominal belanja: Rp ${n.toLocaleString("id-ID")}.`});return}d(!0)};return e.jsxs("div",{className:"p-4 md:p-6 bg-background min-h-screen animate-fadeIn",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:()=>s("/"),className:"w-10 h-10 bg-card rounded-xl shadow-sm border border-border flex items-center justify-center text-muted-foreground active:scale-95 transition-transform",children:e.jsx(R,{className:"w-6 h-6"})}),e.jsx("h2",{className:"text-xl font-bold text-foreground",children:"Input Belanja"})]}),e.jsxs("div",{className:"bg-card p-6 rounded-3xl shadow-sm space-y-4 border border-border",children:[c&&e.jsxs("div",{className:"bg-blue-50 p-4 rounded-xl border border-blue-100 mb-2",children:[e.jsx("p",{className:"text-xs font-bold text-blue-600 uppercase mb-1",children:"Saldo Tersedia"}),e.jsxs("p",{className:"text-lg font-black text-blue-800",children:["Rp ",(c.balance||0).toLocaleString("id-ID")]})]}),e.jsx(A,{label:"Kebutuhan / Judul",value:r,onChange:n=>I(n.target.value)}),e.jsx(A,{label:"Nominal (Rp)",type:"text",inputMode:"numeric",value:Q(o),onChange:n=>D(W(n.target.value)),placeholder:"10.000"}),e.jsx(T,{onClick:y,variant:"danger",className:"w-full",isLoading:l.isPending,children:"Simpan Belanja"})]}),e.jsx(b,{isOpen:h,onClose:()=>d(!1),onConfirm:()=>l.mutate(),title:"Konfirmasi",description:"Simpan data belanja ke sistem?",type:"confirm",confirmLabel:l.isPending?"Menyimpan...":"Ya, Simpan"}),e.jsx(b,{isOpen:f,onClose:()=>{x(!1),s("/")},title:"Berhasil",description:"Data belanja berhasil disimpan!",type:"success"}),e.jsx(b,{isOpen:S.open,onClose:()=>i({open:!1,message:""}),title:"Gagal",description:S.message,type:"error"})]})}export{pe as InputInScreen,ge as InputOutScreen};
