import{j as e,y as q,a as V}from"./ui-DDsedppd.js";import{c as A,r as t}from"./vendor-S3JaNCHW.js";import{u as M}from"./useQuery-ByAfWn1x.js";import{b as E,g as z,I as O,B as F,p as X,d as H,f as Z,a as L}from"./index-Du5XiU4t.js";import{u as K}from"./useMutation-CgPhIM1Z.js";import{S as w}from"./Select-_QQyHLE5.js";import{M as b}from"./Modal-nosIC2CW.js";import{R as ee}from"./config-4dfLyK49.js";const ae=()=>new Date().getMonth()+1,ne=()=>new Date().getFullYear(),T=1e7,B="10.000.000",_=s=>{const u=typeof s=="string"?s.replace(/\D/g,""):s.toString();return u?parseInt(u).toLocaleString("id-ID"):""},Q=s=>s.replace(/\D/g,""),te=()=>{const s=new Date,u=new Date(s.getFullYear(),s.getMonth(),1),h=s.getDate(),d=u.getDay(),p=Math.ceil((h+d)/7);return p>5?5:p};function me(){const s=A(),u=E(),[h,d]=t.useState(!1),[p,x]=t.useState(!1),[S,i]=t.useState({open:!1,message:""}),[o,j]=t.useState(""),[r,N]=t.useState(ae().toString()),[l]=t.useState(ne().toString()),[c,y]=t.useState(te().toString()),[n,k]=t.useState(""),I=t.useRef(null),{data:v,isLoading:W}=M({queryKey:["users"],queryFn:Z.getAll}),{data:g}=M({queryKey:["settings",r,l],queryFn:()=>L.getSettings(parseInt(r),parseInt(l)),staleTime:300*1e3}),{data:R}=M({queryKey:["studentsData",r,l],queryFn:()=>L.getStudents(parseInt(r),parseInt(l)),enabled:!!o}),P=a=>{if(!R||!o)return!1;const f=R.find(G=>G.id.toString()===o);if(!f)return!1;const U=`m${a}`;return(f[U]||0)>0},Y=z(parseInt(l),parseInt(r)-1),m=Array.from({length:Y},(a,f)=>f+1).map(a=>({label:`Minggu ${a}`,value:a.toString(),disabled:P(a)})).filter(a=>!a.disabled);t.useEffect(()=>{v&&v.length>0&&!o&&j(v[0].id.toString())},[v,o]),t.useEffect(()=>{m.length>0?m.some(f=>f.value===c)||y(m[0].value):c!=="-"&&y("-")},[m,c]),t.useEffect(()=>{g?.weeklyFee!==void 0&&(I.current?.m!==r||I.current?.y!==l)&&(k(g.weeklyFee.toString()),I.current={m:r,y:l})},[g,r,l]);const C=K({mutationFn:async()=>X.store({user_id:parseInt(o),bulan:parseInt(r),tahun:parseInt(l),minggu_ke:parseInt(c),nominal:parseInt(n)}),onSuccess:()=>{u.invalidateQueries({queryKey:["students"]}),u.invalidateQueries({queryKey:["dashboardStats"]}),u.invalidateQueries({queryKey:["arrears"]}),d(!1),x(!0)},onError:a=>{d(!1),i({open:!0,message:a.message||"Terjadi kesalahan saat menyimpan data. Silakan coba lagi."})}}),D=g?.is_configured!==!1,$=()=>{if(!o||!n){i({open:!0,message:"Lengkapi semua field!"});return}if(g?.is_configured===!1){i({open:!0,message:"Bulan ini belum dikonfigurasi oleh Admin. Silakan hubungi admin untuk melakukan konfigurasi keuangan di menu Pengaturan."});return}if((!c||c==="-")&&m.length===0){i({open:!0,message:"Mahasiswa ini sudah lunas untuk bulan ini."});return}const a=parseInt(n);if(a>T){i({open:!0,message:`Nominal melebihi batas maksimum. Maksimum input yang diizinkan adalah Rp ${B}. Silakan masukkan nominal yang lebih kecil.`});return}if(a<=0){i({open:!0,message:"Nominal harus lebih dari Rp 0. Silakan masukkan nominal yang valid."});return}d(!0)},J=[{label:"Januari",value:"1"},{label:"Februari",value:"2"},{label:"Maret",value:"3"},{label:"April",value:"4"},{label:"Mei",value:"5"},{label:"Juni",value:"6"},{label:"Juli",value:"7"},{label:"Agustus",value:"8"},{label:"September",value:"9"},{label:"Oktober",value:"10"},{label:"November",value:"11"},{label:"Desember",value:"12"}];return e.jsxs("div",{className:"p-4 md:p-6 bg-background min-h-screen animate-fadeIn",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:()=>s("/"),className:"w-10 h-10 bg-card rounded-xl shadow-sm border border-border flex items-center justify-center text-muted-foreground active:scale-95 transition-transform",children:e.jsx(q,{className:"w-6 h-6"})}),e.jsx("h2",{className:"text-xl font-bold text-foreground",children:"Input Iuran"})]}),W?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(V,{className:"w-8 h-8 animate-spin text-primary"})}):e.jsxs("div",{className:"bg-card p-6 rounded-3xl shadow-sm space-y-4 border border-border",children:[g?.is_configured===!1&&e.jsx("div",{className:"bg-amber-500/10 border border-amber-500/20 text-amber-600 p-4 rounded-xl text-sm font-medium flex items-center gap-2",children:e.jsx("span",{children:"⚠️ Bulan ini belum dikonfigurasi. Tidak dapat menginput data."})}),e.jsx(w,{label:"Nama Mahasiswa",value:o,onChange:a=>j(a.target.value),options:v?.map(a=>({label:a.nama,value:a.id.toString()}))||[]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsx(w,{label:"Bulan",value:r,onChange:a=>N(a.target.value),options:J}),e.jsx(w,{label:"Minggu Ke",value:c,onChange:a=>y(a.target.value),options:m.length>0?m:[{label:"Lunas Semua",value:"-"}],disabled:m.length===0||!D})]}),e.jsx(O,{label:"Nominal (Rp)",type:"text",inputMode:"numeric",value:_(n),onChange:a=>k(Q(a.target.value)),placeholder:"10.000",disabled:!D}),e.jsx(F,{onClick:$,variant:"success",className:"w-full",isLoading:C.isPending,disabled:!D,children:"Simpan Iuran"})]}),e.jsx(b,{isOpen:h,onClose:()=>d(!1),onConfirm:()=>C.mutate(),title:"Konfirmasi",description:"Simpan data iuran ke sistem?",type:"confirm",confirmLabel:C.isPending?"Menyimpan...":"Ya, Simpan"}),e.jsx(b,{isOpen:p,onClose:()=>{x(!1),s("/")},title:"Berhasil",description:"Data iuran berhasil disimpan!",type:"success"}),e.jsx(b,{isOpen:S.open,onClose:()=>i({open:!1,message:""}),title:"Gagal",description:S.message,type:"error"})]})}function pe(){const s=A(),u=E(),[h,d]=t.useState(!1),[p,x]=t.useState(!1),[S,i]=t.useState({open:!1,message:""}),[o,j]=t.useState(""),[r,N]=t.useState(""),{data:l}=M({queryKey:["dashboardStats"],queryFn:L.getStats,staleTime:60*1e3,refetchInterval:ee}),c=K({mutationFn:async()=>{const n=new FormData;return n.append("judul",o),n.append("nominal",r),n.append("tanggal",new Date().toISOString().split("T")[0]),H.store(n)},onSuccess:()=>{u.invalidateQueries({queryKey:["transactions"]}),u.invalidateQueries({queryKey:["dashboardStats"]}),d(!1),x(!0)},onError:n=>{d(!1),i({open:!0,message:n.message||"Gagal menyimpan data belanja."})}}),y=()=>{if(!o||!r){i({open:!0,message:"Lengkapi judul dan nominal!"});return}const n=parseInt(r),k=l?.balance||0;if(n>T){i({open:!0,message:`Nominal melebihi batas maksimum. Maksimum input yang diizinkan adalah Rp ${B}. Silakan masukkan nominal yang lebih kecil.`});return}if(n<=0){i({open:!0,message:"Nominal harus lebih dari Rp 0. Silakan masukkan nominal yang valid."});return}if(n>k){i({open:!0,message:`Saldo tidak cukup! Saldo saat ini: Rp ${k.toLocaleString("id-ID")}, nominal belanja: Rp ${n.toLocaleString("id-ID")}.`});return}d(!0)};return e.jsxs("div",{className:"p-4 md:p-6 bg-background min-h-screen animate-fadeIn",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:()=>s("/"),className:"w-10 h-10 bg-card rounded-xl shadow-sm border border-border flex items-center justify-center text-muted-foreground active:scale-95 transition-transform",children:e.jsx(q,{className:"w-6 h-6"})}),e.jsx("h2",{className:"text-xl font-bold text-foreground",children:"Input Belanja"})]}),e.jsxs("div",{className:"bg-card p-6 rounded-3xl shadow-sm space-y-4 border border-border",children:[l&&e.jsxs("div",{className:"bg-blue-50 p-4 rounded-xl border border-blue-100 mb-2",children:[e.jsx("p",{className:"text-xs font-bold text-blue-600 uppercase mb-1",children:"Saldo Tersedia"}),e.jsxs("p",{className:"text-lg font-black text-blue-800",children:["Rp ",(l.balance||0).toLocaleString("id-ID")]})]}),e.jsx(O,{label:"Kebutuhan / Judul",value:o,onChange:n=>j(n.target.value)}),e.jsx(O,{label:"Nominal (Rp)",type:"text",inputMode:"numeric",value:_(r),onChange:n=>N(Q(n.target.value)),placeholder:"10.000"}),e.jsx(F,{onClick:y,variant:"danger",className:"w-full",isLoading:c.isPending,children:"Simpan Belanja"})]}),e.jsx(b,{isOpen:h,onClose:()=>d(!1),onConfirm:()=>c.mutate(),title:"Konfirmasi",description:"Simpan data belanja ke sistem?",type:"confirm",confirmLabel:c.isPending?"Menyimpan...":"Ya, Simpan"}),e.jsx(b,{isOpen:p,onClose:()=>{x(!1),s("/")},title:"Berhasil",description:"Data belanja berhasil disimpan!",type:"success"}),e.jsx(b,{isOpen:S.open,onClose:()=>i({open:!1,message:""}),title:"Gagal",description:S.message,type:"error"})]})}export{me as InputInScreen,pe as InputOutScreen};
